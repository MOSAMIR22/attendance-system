<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تسجيل الغياب</title>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <style>
    body { font-family: Arial; direction: rtl; padding: 20px; text-align: center; }
    input, button { margin: 10px; padding: 10px; width: 90%; max-width: 300px; }
    #studentSection, #teacherSection { display: none; }
    ul { text-align: right; list-style: none; padding: 0; }
  </style>
</head>
<body>
  <h2>تسجيل الغياب</h2>

  <div id="loginSection">
    <input type="text" id="teacherCode" placeholder="أدخل كود المدرس">
    <button onclick="loginTeacher()">دخول المدرس</button>
  </div>

  <div id="createLecture" style="display:none;">
    <input type="text" id="lectureName" placeholder="اسم المحاضرة">
    <button onclick="createLecture()">إنشاء محاضرة</button>
    <p id="generatedLink"></p>
  </div>

  <div id="studentSection">
    <h3>تسجيل الاسم</h3>
    <input type="text" id="studentName" placeholder="اسم الطالب">
    <button onclick="submitName()">تسجيل</button>
    <p id="confirmation"></p>
  </div>

  <div id="teacherSection">
    <h3>قائمة الحضور</h3>
    <ul id="namesList"></ul>
    <button onclick="generatePDF()">تحميل PDF</button>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCWsnkwFXzfUhag0KyCQAyuqh5Lk1a5qvQ",
    authDomain: "attendance-system-d1fdb.firebaseapp.com",
    projectId: "attendance-system-d1fdb",
    storageBucket: "attendance-system-d1fdb.firebasestorage.app",
    messagingSenderId: "1066060802004",
    appId: "1:1066060802004:web:7abae79e78f0687bcb1841"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const teacherPassword = "123";
  const params = new URLSearchParams(window.location.search);
  const lectureId = params.get("lecture");

  if (lectureId) {
    document.getElementById("studentSection").style.display = "block";
  }

  function loginTeacher() {
    const code = document.getElementById("teacherCode").value.trim();
    if (code === teacherPassword) {
      document.getElementById("loginSection").style.display = "none";
      document.getElementById("createLecture").style.display = "block";
    } else {
      alert("كود غير صحيح");
    }
  }

  function createLecture() {
    const name = document.getElementById("lectureName").value.trim();
    if (!name) return alert("أدخل اسم المحاضرة");

    const newId = Math.random().toString(36).substring(2, 8);
    db.collection("lectures").doc(newId).set({ name: name, created: Date.now() })
      .then(() => {
        const link = window.location.href.split("?")[0] + "?lecture=" + newId;
        document.getElementById("generatedLink").innerHTML = "الرابط: <a href='" + link + "' target='_blank'>" + link + "</a>";
      });
  }

  function submitName() {
    const name = document.getElementById("studentName").value.trim();
    if (!name) return alert("أدخل الاسم");

    const deviceId = localStorage.getItem("attendance_device_id") || Math.random().toString(36).substring(2);
    localStorage.setItem("attendance_device_id", deviceId);

    db.collection("lectures").doc(lectureId).collection("students")
      .doc(deviceId).set({ name: name, timestamp: Date.now() })
      .then(() => {
        document.getElementById("confirmation").textContent = "تم تسجيل الحضور بنجاح";
        document.getElementById("studentName").value = "";
      });
  }

  function generatePDF() {
    if (!lectureId) return alert("غير متصل بمحاضرة");

    db.collection("lectures").doc(lectureId).collection("students")
      .orderBy("timestamp").get().then(snapshot => {
        const data = [["#", "الاسم"]];
        let i = 1;
        snapshot.forEach(doc => {
          data.push([i++, doc.data().name]);
        });

        const docDefinition = {
          content: [
            { text: "كشف الحضور", style: "header" },
            {
              table: {
                headerRows: 1,
                widths: ["auto", "*"],
                body: data
              }
            }
          ],
          defaultStyle: { font: "Helvetica" },
          styles: {
            header: { fontSize: 18, bold: true, margin: [0, 0, 0, 10] }
          }
        };
        pdfMake.createPdf(docDefinition).download("attendance.pdf");
      });
  }
</script>
</body>
</html>
